apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "openclaw.vault.fullname" . }}-bootstrap
  namespace: {{ include "openclaw.namespace" . }}
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
    app.kubernetes.io/component: vault-bootstrap
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "openclaw.vault.fullname" . }}-bootstrap
  namespace: {{ include "openclaw.namespace" . }}
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
    app.kubernetes.io/component: vault-bootstrap
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "openclaw.vault.fullname" . }}-bootstrap
  namespace: {{ include "openclaw.namespace" . }}
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
    app.kubernetes.io/component: vault-bootstrap
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "openclaw.vault.fullname" . }}-bootstrap
subjects:
  - kind: ServiceAccount
    name: {{ include "openclaw.vault.fullname" . }}-bootstrap
    namespace: {{ include "openclaw.namespace" . }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "openclaw.vault.fullname" . }}-auto-bootstrap
  namespace: {{ include "openclaw.namespace" . }}
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
    app.kubernetes.io/component: vault-bootstrap
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "5"
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 10
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "openclaw.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: vault-bootstrap
    spec:
      serviceAccountName: {{ include "openclaw.vault.fullname" . }}-bootstrap
      restartPolicy: OnFailure
      volumes:
        - name: out
          emptyDir: {}
        - name: bootstrap-keys
          secret:
            secretName: {{ include "openclaw.vault.fullname" . }}-bootstrap-keys
            optional: true
      initContainers:
        - name: vault-init
          image: hashicorp/vault:latest
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -ec
            - |
              export VAULT_ADDR="{{ printf "http://%s:8200" (include "openclaw.vault.fullname" .) }}"
              echo "Waiting for Vault at $VAULT_ADDR..."
              OUT=""
              for i in $(seq 1 90); do
                OUT=$(vault status 2>&1) || true
                if echo "$OUT" | grep -q "not initialized\|Sealed\|Initialized"; then break; fi
                [ "$i" -eq 90 ] && { echo "Vault did not become ready"; exit 1; }
                sleep 2
              done
              if echo "$OUT" | grep -q "not initialized"; then
                echo "Initializing Vault..."
                vault operator init -key-shares=1 -key-threshold=1 2>&1 | tee /tmp/init.out
                grep "Unseal Key 1:" /tmp/init.out | sed 's/.*: *//' | tr -d '\r' > /out/unseal_key
                grep "Initial Root Token:" /tmp/init.out | sed 's/.*: *//' | tr -d '\r' > /out/root_token
              else
                echo "Vault already initialized, copying keys from Secret..."
                cp /vault-bootstrap-keys/root_token /out/root_token 2>/dev/null || true
                cp /vault-bootstrap-keys/unseal_key /out/unseal_key 2>/dev/null || true
                [ -s /out/root_token ] || { echo "Secret has no root_token"; exit 1; }
              fi
          env:
            - name: VAULT_ADDR
              value: {{ printf "http://%s:8200" (include "openclaw.vault.fullname" .) | quote }}
          volumeMounts:
            - name: out
              mountPath: /out
            - name: bootstrap-keys
              mountPath: /vault-bootstrap-keys
              readOnly: true
      containers:
        - name: bootstrap
          image: alpine:3.19
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -ec
            - |
              set -e
              apk add --no-cache curl unzip ca-certificates
              VAULT_VER=1.15.0
              curl -sSLo /tmp/vault.zip "https://releases.hashicorp.com/vault/${VAULT_VER}/vault_${VAULT_VER}_linux_amd64.zip"
              unzip -o /tmp/vault.zip -d /usr/local/bin && chmod +x /usr/local/bin/vault
              curl -sSLo /usr/local/bin/kubectl "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl" && chmod +x /usr/local/bin/kubectl

              export VAULT_ADDR="{{ printf "http://%s:8200" (include "openclaw.vault.fullname" .) }}"
              export VAULT_TOKEN="$(cat /out/root_token)"
              UNSEL_KEY="$(cat /out/unseal_key)"

              # Persist keys to Secret for next run (e.g. after pod restart)
              kubectl create secret generic {{ include "openclaw.vault.fullname" . }}-bootstrap-keys \
                --from-file=unseal_key=/out/unseal_key --from-file=root_token=/out/root_token \
                -n "${NAMESPACE}" --dry-run=client -o yaml | kubectl apply -f -

              vault operator unseal "$UNSEL_KEY"
              vault secrets enable -path=openclaw kv-v2 2>/dev/null || true
              vault policy write openclaw-read - <<'POLICY'
              path "openclaw/data/*" { capabilities = ["read"] }
              path "openclaw/metadata/*" { capabilities = ["read"] }
              POLICY
              GATEWAY_TOKEN=$(vault token create -policy=openclaw-read -no-default-policy -field=client_token)
              kubectl create secret generic {{ .Values.vault.existingSecret | quote }} \
                --from-literal=token="$GATEWAY_TOKEN" -n "${NAMESPACE}" \
                --dry-run=client -o yaml | kubectl apply -f -
              echo "Vault auto-bootstrap complete."
          env:
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          volumeMounts:
            - name: out
              mountPath: /out
              readOnly: true
