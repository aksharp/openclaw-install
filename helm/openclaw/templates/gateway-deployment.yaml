apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "openclaw.gateway.fullname" . }}-wait-secret
  namespace: {{ include "openclaw.namespace" . }}
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: [{{ .Values.vault.existingSecret | quote }}]
    verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "openclaw.gateway.fullname" . }}-wait-secret
  namespace: {{ include "openclaw.namespace" . }}
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "openclaw.gateway.fullname" . }}-wait-secret
subjects:
  - kind: ServiceAccount
    name: default
    namespace: {{ include "openclaw.namespace" . }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "openclaw.gateway.fullname" . }}
  namespace: {{ include "openclaw.namespace" . }}
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
    app.kubernetes.io/component: gateway
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "openclaw.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/component: gateway
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "openclaw.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: gateway
        {{- include "openclaw.labels" . | nindent 8 }}
    spec:
      securityContext:
        runAsNonRoot: {{ .Values.gateway.securityContext.runAsNonRoot }}
        runAsUser: {{ .Values.gateway.securityContext.runAsUser }}
        runAsGroup: {{ .Values.gateway.securityContext.runAsGroup }}
        fsGroup: {{ .Values.gateway.securityContext.runAsGroup }}
      initContainers:
        - name: wait-for-vault-token
          image: alpine:3.19
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache curl
              KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
              KUBE_CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              NS="{{ default .Release.Namespace .Values.namespaceOverride }}"
              SECRET="{{ .Values.vault.existingSecret }}"
              echo "Waiting for vault gateway token secret..."
              for i in $(seq 1 90); do
                if curl -sSf -H "Authorization: Bearer $KUBE_TOKEN" --cacert "$KUBE_CA" \
                  "https://kubernetes.default.svc/api/v1/namespaces/$NS/secrets/$SECRET" >/dev/null 2>&1; then
                  echo "Secret found."
                  exit 0
                fi
                echo "Attempt $i/90: secret not found, waiting 5s..."
                sleep 5
              done
              echo "Timeout waiting for secret"
              exit 1
      containers:
        - name: gateway
          image: "{{ .Values.openclaw.image.repository }}:{{ .Values.openclaw.image.tag }}"
          imagePullPolicy: {{ .Values.openclaw.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.gateway.port }}
              protocol: TCP
          env:
            - name: OPENCLAW_GATEWAY_PORT
              value: {{ .Values.gateway.port | quote }}
            - name: VAULT_ADDR
              value: {{ printf "http://%s:8200" (include "openclaw.vault.fullname" .) | quote }}
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.vault.existingSecret }}
                  key: {{ .Values.vault.secretKey }}
          envFrom:
            - configMapRef:
                name: {{ include "openclaw.gateway.fullname" . }}-config
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: openclaw-data
              mountPath: /home/node/.openclaw
          resources:
            {{- toYaml .Values.gateway.resources | nindent 12 }}
          # OpenClaw gateway may use a different health path; adjust or remove if needed
          livenessProbe:
            tcpSocket:
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            tcpSocket:
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: {{ .Values.gateway.tmpfsSize }}
        - name: openclaw-data
          persistentVolumeClaim:
            claimName: {{ include "openclaw.gateway.fullname" . }}-data
      restartPolicy: Always
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "openclaw.gateway.fullname" . }}-data
  namespace: {{ include "openclaw.namespace" . }}
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
    app.kubernetes.io/component: gateway
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
